<!-- chat-bar polymer custom element -->

<!-- iron-elements -->
<link rel="import" href="../../bower_components/iron-list/iron-list.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">

<!-- paper-elements -->
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">


<!-- custom-elements -->
<link rel="import" href="../message-item/message-item.html">
<link rel="import" href="../message-input/message-input.html">

<!-- other imports -->
<link rel="import" href="../../bower_components/font-roboto/roboto.html">

<dom-module id="chat-bar">

  <template>
    <style is="custom-style">
      :host {
        /* CSS Variables */
        --element-border-radius: var(--ext-element-border-radius, 2px);
        --element-accent: var(--ext-element-accent, #3F51B5);
        --element-dark-color: var(--ext-element-dark-color, rgba(0,0,0,.87));
        --element-light-color: var(--ext-element-light-color, rgba(255,255,255,1));
        --element-light-transparent-color: var(rgba(255,255,255,.7));
        --element-paper-color: var(--ext-element-paper-color, #FAFAFA);

        @apply(--layout);
        @apply(--layout-flex-auto);

        /*border: dashed 1px rgb(218,218,218);*/
        font-family: 'Roboto', sans-serif;
      }

      #element-paper {
        @apply(--layout-flex);
        @apply(--layout-horizontal);
        overflow: hidden;
        border-radius: var(--element-border-radius);
        background-color: var(--element-paper-color);
      }

      .messaging-wrapper {
        @apply(--layout-vertical);
        @apply(--layout-flex);
      }

      iron-list {
        padding: 15px;
      }

      #message-list {
        @apply(--layout-flex);
        color: var(--element-dark-color);
      }

      .header-panel-title {
        padding: 10px;
        padding-left: 15px;
        border-top-right-radius: var(--element-border-radius);
        background-color: var(--element-accent);
        color: var(--element-light-color);
        font-weight: bold;
      }

      #user-list {
        width: 160px;
        /*min-height: 200px;*/
        border-bottom-right-radius: var(--element-border-radius);
        border-top-right-radius: var(--element-border-radius);
        color: var(--element-dark-color);
        -webkit-box-shadow: -3px 0px 10px -2px rgba(0,0,0,0.3);
        -moz-box-shadow: -3px 0px 10px -2px rgba(0,0,0,0.3);
        box-shadow: -3px 0px 10px -2px rgba(0,0,0,0.3);
      }

      /* TODO: Get rid of these styles */
      /*#test-message-bar {
        height: 40px;
        background-color: var(--element-accent);
      }*/

      @media (max-width: 560px) {
        #user-list {
          display: none;
        }
      }
    </style>

    <paper-dialog id="username-dialog" with-backdrop no-cancel-on-outside-click>
      <h2>Enter a username</h2>
      <paper-input id="username-input" label="Username" value="{{username}}"></paper-input>
      <div class="buttons">
        <paper-button id="username-submit-button" on-click="addUser">Connect</paper-button>
      </div>
    </paper-dialog>

    <paper-material id="element-paper" elevation="1">

      <div class="messaging-wrapper">
        <!-- Message List -->
        <iron-list id="message-list" items="[[messageList]]" as="item">
          <template>
            <message-item data="[[item.data]]" message></message-item>
          </template>
        </iron-list>

        <message-input></message-input>

      </div>

      <!-- Online User List -->
      <div id="user-list">
        <div class="header-panel-title">
          Online
        </div>
        <iron-list items="[[userList]]" as="item">
          <template>
            <div>[[item.data.user]]</div>
          </template>
        </iron-list>
      </div>
    </paper-material>

  </template>

  <script>
    Polymer({
      is: 'chat-bar',

      properties: {
        userList: {
          type: Array

          /* userList Schema
            [
              {
                index: 0,
                data: {
                  user: 'Sean'
                }
              }
            ]
          */
        },

        messageList: {
          type: Array

          /* messageList Schema
            [
              {
                index: <timestamp>,
                data: {
                  nick: <nickname>,
                  msg: <message data>
                }
              }
            ]
          */
        },

        currentUser: {
          type: String,
          value: ''
        },
        newestMessageIdx: Number
      },

      listeners: {
        'submit-message': 'submitMessage'
      },

      // When the username-submit-button is pressed, add the user
      addUser: function() {
        var _this = this;
        _this.socket.emit('new user', _this.username, function(data){
          // If the username is valid...
          if(data) {
            _this.currentUser = _this.username;
            _this.$['username-dialog'].close();
          } else {
            // TODO: Handle the invalid username callback
          }
        });

      },

      // Send the message to the server
      submitMessage: function(e) {
        this.socket.emit('send message', e.detail.message, function(data){
          // TODO: Handle this callback
        });
      },

      // TODO: Fire an iron-list resize when element is ready

      // element lifecycle
      attached: function() {
        this.onAttached();
      },

      // io implementation
      onAttached: function() {
        var _this = this;
        var loaded = false;

        // Open the username dialog to retrieve username
        _this.$['username-dialog'].open();

        // Open the socket connection
        _this.socket = io.connect();

        // Receive the list of usernames
        _this.socket.on('usernames', function(data){
          var index = 0;

          // crank through incoming users and formulate a list data object
          _this.userList = data.map(function(entry) {
            return {
              index: index++,
              data: {
                user: entry
              }
            };
          });
        });

        // Receive the message history
        _this.socket.on('load old msgs', function(data) {
          // check to see if the messages have already been loaded
          if(!loaded) {
            // then load the old messages
            loaded = true;

            // crank through incoming messages and formulate a list data object, reversed
            _this.messageList = data.map(function(entry) {
              // Check if the message belongs to the viewer
              entry.isOwner = (entry.nick === _this.currentUser);

              // Update the newest message index
              newestMessageIdx = entry.ts;
              return {
                index: entry.ts,
                data: entry // REVIEW: Consider omitting the timestamp from the data key
              };
            }).reverse();
          }

          // TODO: scroll to the most recent message
        });

        // Receieve a new message
        _this.socket.on('new message', function(entry){
          // Append the list data using the provided `push` method
          newestMessageIdx = entry.ts;

          // Check if the message belongs to the viewer
          entry.isOwner = (entry.nick === _this.currentUser);
          _this.push('messageList', {
            index: entry.ts,
            data: entry
          });
        });
      }
    });

  </script>
</dom-module>
